<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phishing Detector</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>The Phishing Detector</h1>
            <p class="subtitle">AI-Powered Analysis</p>
        </header>

        <main>
            <div class="card input-card">
                <form id="analyzeForm">
                    <div class="form-group">
                        <textarea name="email_text" id="emailText" placeholder="Paste email content here..."
                            required></textarea>
                    </div>
                    <button type="submit" id="analyzeBtn">Analyze Content</button>
                </form>
            </div>

            <div id="resultContainer" class="result-container hidden">
                <!-- Result card will be injected here -->
            </div>
        </main>
    </div>

    <script>
        document.getElementById('analyzeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = document.getElementById('emailText').value;
            const btn = document.getElementById('analyzeBtn');
            const container = document.getElementById('resultContainer');

            // Loading state
            btn.textContent = "Analyzing...";
            btn.disabled = true;
            container.classList.add('hidden');
            container.innerHTML = '';

            try {
                const formData = new FormData();
                formData.append('email_text', text);

                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                // Construct Result Card
                const isPhishing = data.is_phishing;
                const label = isPhishing ? "PHISHING DETECTED" : "LEGITIMATE EMAIL";
                const prob = (data.probability * 100).toFixed(1);

                // Build metadata section
                const metadataHtml = `
                    <div class="metadata-section">
                        <h3>Email Analysis</h3>
                        <div class="metadata-grid">
                            <div class="meta-item">
                                <span class="meta-label">Confidence</span>
                                <span class="meta-value">${data.confidence_level}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">URLs Found</span>
                                <span class="meta-value">${data.metadata.url_count}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Text Length</span>
                                <span class="meta-value">${data.metadata.text_length} chars</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Avg Word Length</span>
                                <span class="meta-value">${data.metadata.avg_word_length}</span>
                            </div>
                        </div>
                    </div>
                `;

                // Build risk factors section
                let riskHtml = '';
                if (data.risk_factors && data.risk_factors.length > 0) {
                    const riskItems = data.risk_factors.map(risk => {
                        const severityIcon = risk.severity === 'high' ? '●' : risk.severity === 'medium' ? '◐' : '○';
                        const extraInfo = risk.count ? ` (${risk.count})` : risk.value ? `: ${risk.value}` : '';
                        const examples = risk.examples ? ` - ${risk.examples.join(', ')}` : '';
                        return `<li><span class="risk-indicator ${risk.severity}">${severityIcon}</span> ${risk.factor}${extraInfo}${examples}</li>`;
                    }).join('');
                    riskHtml = `
                        <div class="risk-section">
                            <h3>Risk Factors</h3>
                            <ul class="risk-list">${riskItems}</ul>
                        </div>
                    `;
                }

                // Build safe indicators section
                let safeHtml = '';
                if (data.safe_indicators && data.safe_indicators.length > 0) {
                    const safeItems = data.safe_indicators.map(safe => {
                        return `<li>✓ ${safe.indicator}</li>`;
                    }).join('');
                    safeHtml = `
                        <div class="safe-section">
                            <h3>Safe Indicators</h3>
                            <ul class="safe-list">${safeItems}</ul>
                        </div>
                    `;
                }

                // Build recommendation section
                const recommendationHtml = `
                    <div class="recommendation-section ${isPhishing ? 'danger-rec' : 'safe-rec'}">
                        <h3>Recommendation</h3>
                        <p class="recommendation-text">${data.recommendation}</p>
                        <p class="action-text">${data.action}</p>
                    </div>
                `;

                let contentHtml = '';

                if (data.explanation && data.explanation.length > 0) {
                    // Sort by start index to handle highlighting correctly
                    const highlights = data.explanation.sort((a, b) => a.start - b.start);

                    let lastIdx = 0;
                    let highlightedText = "";

                    // Reconstruct text with spans
                    // We need the original text. Since we sent it, we have it in 'text' variable.
                    // But wait, the offsets are from the BERT tokenizer which might match the original text 
                    // if we are lucky, but usually it matches the cleaned/tokenized version.
                    // However, 'return_offsets_mapping=True' in transformers usually maps to the *original* string 
                    // provided to the tokenizer.

                    highlights.forEach(h => {
                        // Append text before the highlight
                        highlightedText += text.substring(lastIdx, h.start);

                        // Append highlighted text
                        // Calculate opacity based on score (0.0 to 1.0)
                        const opacity = Math.min(Math.max(h.score * 2, 0.2), 1.0);
                        highlightedText += `<span class="highlight" style="background-color: rgba(255, 0, 0, ${opacity});" title="Score: ${h.score.toFixed(3)}">${text.substring(h.start, h.end)}</span>`;

                        lastIdx = h.end;
                    });

                    // Append remaining text
                    highlightedText += text.substring(lastIdx);

                    contentHtml = `
                        <div class="analysis-view">
                            <h3>Analysis</h3>
                            <div class="text-content">${highlightedText.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                } else {
                    contentHtml = `<div class="text-content">${text.replace(/\n/g, '<br>')}</div>`;
                }

                const resultHtml = `
                    <div class="card result-card ${isPhishing ? 'danger' : 'safe'}">
                        <div class="result-header">
                            <h2>${label}</h2>
                            <div class="confidence">Probability: ${prob}%</div>
                        </div>
                        ${metadataHtml}
                        ${riskHtml}
                        ${safeHtml}
                        ${recommendationHtml}
                        ${contentHtml}
                    </div>
                `;

                container.innerHTML = resultHtml;
                container.classList.remove('hidden');

            } catch (err) {
                console.error(err);
                alert("An error occurred during analysis.");
            } finally {
                btn.textContent = "Analyze Content";
                btn.disabled = false;
            }
        });
    </script>
</body>

</html>